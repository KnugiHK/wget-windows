name: Build wget for Windows

on:
  push:
    tags:
      - v*
    branches:
      - '**'
    paths-ignore:
      - 'README.md'
      - 'RELEASE.md'
      - '.github/generate-website.js'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  # --- x64 Build Job ---
  build-x64:
    name: Build x64
    runs-on: ubuntu-24.04
    outputs:
      WGET_VERSION: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v6

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 mingw-w64-tools gcc make m4 pkg-config automake gettext

      - name: Build wget x64
        run: |
          x86_64-w64-mingw32-gcc --version
          ./build.sh x64
          VERSION=$(grep -Po '(?<=wget-)\d+\.\d{2}\.\d+' build.sh | uniq)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted: $VERSION"

      - name: Attest x64 Binaries
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            build-wget-x64/install/wget-gnutls/wget-gnutls-x64.exe
            build-wget-x64/install/wget-openssl/wget-openssl-x64.exe

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wget-x64-binaries
          path: |
            build-wget-x64/install/wget-gnutls/wget-gnutls-x64.exe
            build-wget-x64/install/wget-openssl/wget-openssl-x64.exe

  # --- x86 Build Job ---
  build-x86:
    name: Build x86
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-i686-dev gcc make m4 pkg-config automake gettext

      - name: Build wget x86
        run: |
          i686-w64-mingw32-gcc --version
          ./build.sh x86

      - name: Attest x86 Binaries
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            build-wget-x86/install/wget-gnutls/wget-gnutls-x86.exe
            build-wget-x86/install/wget-openssl/wget-openssl-x86.exe

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wget-x86-binaries
          path: |
            build-wget-x86/install/wget-gnutls/wget-gnutls-x86.exe
            build-wget-x86/install/wget-openssl/wget-openssl-x86.exe

  # --- arm64 Build Job ---
  build-arm64:
    name: Build arm64
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-i686-dev gcc make m4 pkg-config automake gettext

      - name: Build wget arm64
        run: |
          ./build.sh arm64

      - name: Attest arm64 Binaries
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            build-wget-arm64/install/wget-gnutls/wget-gnutls-arm64.exe
            build-wget-arm64/install/wget-openssl/wget-openssl-arm64.exe

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wget-arm64-binaries
          path: |
            build-wget-arm64/install/wget-gnutls/wget-gnutls-arm64.exe
            build-wget-arm64/install/wget-openssl/wget-openssl-arm64.exe

  test-windows-x86:
    name: Test Binaries on Windows (x86-x64)
    needs: [build-x64, build-x86]
    runs-on: windows-latest
    env:
      WGET_VERSION: ${{ needs.build-x64.outputs.wget_version }}
      PYTHONUTF8: 1
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: ./test-bins

      - name: Run Tests in Python
        shell: pwsh
        run: |
          $executables = Get-ChildItem ./test-bins -Filter *.exe -Exclude *arm64.exe -Recurse | Select-Object -ExpandProperty FullName
          python wget_tests.py $executables

  test-windows-arm64:
    name: Test Binaries on Windows (arm64)
    needs: [build-arm64]
    runs-on: windows-11-arm
    env:
      WGET_VERSION: ${{ needs.build-x64.outputs.wget_version }}
      PYTHONUTF8: 1
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: ./test-bins

      - name: Run Tests in Python
        shell: pwsh
        run: |
          $executables = Get-ChildItem ./test-bins -Filter *arm64.exe -Recurse | Select-Object -ExpandProperty FullName
          python wget_tests.py $executables

  # --- Release Job ---
  release:
    name: Create Release
    needs: [build-x64, build-x86, build-arm64, test-windows-x86, test-windows-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: ./downloads

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "./downloads/**/*.exe"
          bodyFile: "RELEASE.md"
          token: ${{ secrets.GITHUB_TOKEN }}
