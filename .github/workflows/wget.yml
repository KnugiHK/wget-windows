name: wget

on:
  create:
    tags:
      - v*
  workflow_dispatch:

jobs:
  # --- 64-bit Build Job ---
  build-x64:
    name: Build x64
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 mingw-w64-tools gcc make m4 pkg-config automake gettext libiconv-hook-dev

      - name: Build wget 64-bit
        run: |
          x86_64-w64-mingw32-gcc --version
          ./build.sh

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wget-x64-binaries
          path: |
            build-wget/install/wget-gnutls/wget-gnutls-x64.exe
            build-wget/install/wget-openssl/wget-openssl-x64.exe

  # --- 32-bit Build Job ---
  build-x86:
    name: Build x86
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-i686-dev gcc make m4 pkg-config automake gettext libiconv-hook-dev

      - name: Build wget 32-bit
        run: |
          i686-w64-mingw32-gcc --version
          ./build-x86.sh

      - name: Archive artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wget-x86-binaries
          path: |
            build-wget-x86/install/wget-gnutls/wget-gnutls-x86.exe
            build-wget-x86/install/wget-openssl/wget-openssl-x86.exe

  # --- Release Job ---
  release:
    name: Create Release
    needs: [build-x64, build-x86]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v6
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloads

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "./downloads/**/*.exe"
          bodyFile: "RELEASE.md"
          token: ${{ secrets.GITHUB_TOKEN }}